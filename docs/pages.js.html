<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: pages.js</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: pages.js</h1>


    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** Express router providing html pages
 * @module routes/pages
 * @requires express
 */

/**
 * express module
 * @const
 */
const express = require('express');

/**
 * Express router to mount hhtml pages on.
 * @type {object}
 * @const
 * @namespace usersRouter
 */
const router = express.Router();
const path = require('path');
const passport = require('passport');
const frontendPath = path.join(__dirname, '../../frontend', '/build');
const db = require('../controllers/dbController.js');
const fs = require('fs');

const auth = (req, res, next) => {
  if (req.isAuthenticated()) {
    if (req.user.Registered)
        next();
    else return res.redirect('/register')
  }
  else {
    return res.redirect('/login')
  }
};

const regAuth = (req, res, next) => {
    if (req.isAuthenticated()) {
       next()
    }
    else {
        return res.redirect('/login')
    }
};

const adminAuth = async (req, res, next) => {
  if (req.user._json &amp;&amp; req.user._json.email)
      id = req.user._json.email;
  else id = req.user.user_id;
    let User = await db.findUserById(id);
  if (req.isAuthenticated() &amp;&amp; User.Role === 'Admin') {
    next()
  }
  else {
    return res.redirect('/404')
  }
};

const superAdminAuth = async (req, res, next) => {
  if (req.user._json &amp;&amp; req.user._json.email)
      id = req.user._json.email;
  else id = req.user.user_id;
    let User = await db.findUserById(id);
  if (req.isAuthenticated() &amp;&amp; User.Role === 'SuperAdmin') {
    next()
  }
  else {
    return res.redirect('/404')
  }
};

router.get('/', (req, res) => res.redirect('/home'));

router.get('/login', passport.authenticate('auth0', {
    scope: 'openid email profile'
  }), function (req, res) {
    res.redirect('/')
  });

router.get('/callback', function (req, res, next) {
    passport.authenticate('auth0', function (err, user, info) {
      if (err) { return next(err) }
      if (!user) { return res.redirect('/login') }
      req.logIn(user, function (err) {
        if (err) { return next(err) }
          const returnTo = req.session.returnTo;
          delete req.session.returnTo;
        res.redirect(returnTo || '/home')
      });
    })(req, res, next)
});


var homepage = fs.readFileSync(path.join(frontendPath, '/user_main.html')).toString();

router.get('/home', auth,  (req, res) => {
  res.sendFile(path.join(frontendPath, '/user_main.html'))
});

router.get('/register',regAuth, (req, res) => {
    res.sendFile(path.join(frontendPath, '/register.html'))
});


router.get('/upload',auth,(req, res) => {
  res.sendFile(path.join(frontendPath, '/add.html'))
});

router.get('/prims',auth,(req, res) => {
    res.sendFile(path.join(frontendPath, '/prim.html'))
});

router.get('/profile',auth,(req, res) => {
    res.sendFile(path.join(frontendPath, '/myprofile.html'))
});

router.get('/editProfile',auth,(req, res) => {
    res.sendFile(path.join(frontendPath, '/edit_myprofile.html'))
});

router.get('/achievement/:id',
    async (req, res, next) => {
    if (req.user._json &amp;&amp; req.user._json.email)
        id = req.user._json.email;
    else id = req.user.user_id;
    let User = await db.findUserById(id);
    if (req.isAuthenticated() &amp;&amp;  (User.Achievement.some(o => o == req.params.id) || User.Role === 'Admin' || User.Role === 'SuperAdmin')) {
        next()
    }
    else {
        return res.redirect('/404')
    }},
    (req, res) => {
    res.sendFile(path.join(frontendPath, '/achievement.html'))
    });

router.get('/documents',auth,(req, res) => {
  res.sendFile(path.join(frontendPath, '/criterion.html'))
});

router.get('/logout', (req, res) => {
    req.session.destroy();
    req.logout();
  res.redirect('/home')
});

router.get('/admin',adminAuth, (req, res) => {
  res.sendFile(path.join(frontendPath, '/admin.html'))
});

router.get('/processed',adminAuth,(req, res) => {
  res.sendFile(path.join(frontendPath, '/processed.html'))
});

router.get('/rating',adminAuth, (req, res) => {
  res.sendFile(path.join(frontendPath, '/rating.html'))
});

router.get('/info',adminAuth, (req, res) => {
  res.sendFile(path.join(frontendPath, '/info.html'))
});

router.get('/history', adminAuth, (req, res) => {
    res.sendFile(path.join(frontendPath, '/adminHistory.html'))
});

router.get('/currentAchieves', adminAuth, (req, res) => {
    res.sendFile(path.join(frontendPath, '/currentAchieves.html'))
});


router.get('/user/*',adminAuth, (req, res) => {
  res.sendFile(path.join(frontendPath, '/profile_admin.html'))
});

router.get('/superAdmin', superAdminAuth, (req,res)=>{
  res.sendFile(path.join(frontendPath, '/superAdmin.html'))
});

router.get('/superProcessed', superAdminAuth, (req,res)=>{
  res.sendFile(path.join(frontendPath, '/superProcessed.html'))
});

router.get('/superRating', superAdminAuth, (req,res)=>{
  res.sendFile(path.join(frontendPath, '/superRating.html'))
});

router.get('/admins', superAdminAuth, (req,res)=>{
  res.sendFile(path.join(frontendPath, '/adminList.html'))
});

router.get('*', function (req, res) {
  res.sendFile(path.join(frontendPath, '/404.html'))
});

module.exports = router;
</code></pre>
        </article>
    </section>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
    <h3>Modules</h3>
    <ul>
        <li><a href="module-routes_pages.html">routes/pages</a></li>
    </ul>
    <h3>Namespaces</h3>
    <ul>
        <li><a href="module-routes_pages-usersRouter.html">usersRouter</a></li>
    </ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Mar 16 2019 10:15:36
    GMT+0300 (RTZ 2 (зима))
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
